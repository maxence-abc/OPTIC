{% extends 'base.html.twig' %}

{% block title %}Nouveau rendez-vous{% endblock %}

{% block body %}
<div class="container mt-4">
    <h1 class="mb-4">Prendre un rendez-vous</h1>

    {{ form_start(form, { attr: { id: 'appointment-form' } }) }}
        <div class="row">
            <div class="col-md-6 mb-3">
                {{ form_row(form.service) }}
            </div>
            <div class="col-md-6 mb-3">
                {{ form_row(form.date) }}
            </div>
        </div>

        <div class="row">
            <div class="col-md-6 mb-3">
                {{ form_row(form.startTime) }}
            </div>
            <div class="col-md-6 mb-3">
                {{ form_row(form.equipement) }}
            </div>
        </div>

        <div class="mt-4">
            <button class="btn btn-success">Enregistrer</button>
            <a href="{{ path('app_appointment_index') }}" class="btn btn-secondary">Retour</a>
        </div>
    {{ form_end(form) }}

    {% if appointment.endTime is not null %}
        <div class="alert alert-info mt-4">
            Heure de fin prévue : <strong>{{ appointment.endTime|date('H:i') }}</strong>
        </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const serviceField = document.querySelector('#appointment_service');
  const dateField = document.querySelector('#appointment_date');
  const equipField = document.querySelector('#appointment_equipement');
  const slotField = document.querySelector('#appointment_startTime');

  if (!slotField) return;

  function setSlots(slots) {
    slotField.innerHTML = '';

    const placeholder = document.createElement('option');
    placeholder.value = '';
    placeholder.textContent = (slots && slots.length)
      ? 'Choisissez un créneau'
      : 'Aucun créneau disponible';
    slotField.appendChild(placeholder);

    if (slots && slots.length) {
      for (const t of slots) {
        const opt = document.createElement('option');
        opt.value = t;
        opt.textContent = t;
        slotField.appendChild(opt);
      }
    }

    slotField.disabled = !(slots && slots.length);
  }

  async function refreshSlots() {
    const service = serviceField?.value;
    const date = dateField?.value;
    const equip = equipField?.value;

    if (!service || !date) {
      setSlots([]);
      return;
    }

    slotField.disabled = true;
    slotField.innerHTML = '<option value="">Chargement...</option>';

    const params = new URLSearchParams();
    params.set('service', service);
    params.set('date', date);
    if (equip) params.set('equipement', equip);

    const url = "{{ path('app_appointment_slots') }}" + '?' + params.toString();

    try {
      const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
      const data = await res.json();
      setSlots(data.slots || []);
    } catch (e) {
      setSlots([]);
    }
  }

  serviceField?.addEventListener('change', refreshSlots);
  dateField?.addEventListener('change', refreshSlots);
  equipField?.addEventListener('change', refreshSlots);

  refreshSlots();
});
</script>

{% endblock %}
