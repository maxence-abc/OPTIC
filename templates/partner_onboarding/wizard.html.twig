{% extends 'base.html.twig' %}

{% block title %}Devenir partenaire - Étape {{ step }}{% endblock %}

{% block stylesheets %}
  {{ parent() }}
  <link rel="stylesheet" href="/css/pages/partner-onboarding.css">
{% endblock %}

{% block body %}
  <div class="auth-page partner-onboarding">
    <main class="main">
      <div class="auth-card">
        <div class="auth-card__inner">

          <div class="partner-stepper" aria-label="Progression">
            <div class="partner-stepper__dot {{ step >= 1 ? 'is-active' : '' }}">1</div>
            <div class="partner-stepper__line"></div>
            <div class="partner-stepper__dot {{ step >= 2 ? 'is-active' : '' }}">2</div>
            <div class="partner-stepper__line"></div>
            <div class="partner-stepper__dot {{ step >= 3 ? 'is-active' : '' }}">3</div>
          </div>

          <div class="auth-card__top">
            <h1 class="auth-card__title">Créer votre établissement</h1>
            <p class="auth-card__subtitle">Étape {{ step }} sur 3</p>
          </div>

          {% if form is defined and form.vars.submitted and not form.vars.valid %}
            <div class="auth-alert auth-alert--error">
              Certains champs sont incorrects. Vérifie les erreurs ci-dessous.
            </div>
          {% endif %}

          {{ form_start(form, { attr: { class: 'auth-form' } }) }}

            {# Rendu “smart” : on garde ton loop, mais on spécialise les collections #}
            {% for child in form %}
              {% if child.vars.name != '_token' %}

                {# SERVICES #}
                {% if child.vars.name == 'services' %}
                  <div class="auth-field">
                    <div class="auth-label">Services proposés</div>

                    <div
                      id="services-collection"
                      data-prototype="{{ form_widget(child.vars.prototype)|e('html_attr') }}"
                      data-index="{{ child|length }}"
                    >
                      {% for item in child %}
                        <div class="auth-input js-item">
                          {{ form_widget(item) }}
                        </div>
                      {% endfor %}
                    </div>

                    <div style="margin-top: 12px;">
                      <button type="button" class="btn btn--outline btn--lg" id="add-service">
                        Ajouter un service
                      </button>
                    </div>

                    {{ form_errors(child) }}
                  </div>

                {# OPENING HOURS #}
                {% elseif child.vars.name == 'openingHours' %}
                  <div class="auth-field">
                    <div class="auth-label">Horaires d’ouverture</div>

                    <div
                      id="hours-collection"
                      data-prototype="{{ form_widget(child.vars.prototype)|e('html_attr') }}"
                      data-index="{{ child|length }}"
                    >
                      {% for item in child %}
                        <div class="auth-input js-item">
                          {{ form_widget(item) }}
                        </div>
                      {% endfor %}
                    </div>

                    <div style="margin-top: 12px;">
                      <button type="button" class="btn btn--outline btn--lg" id="add-hour">
                        Ajouter un horaire
                      </button>
                    </div>

                    {{ form_errors(child) }}
                  </div>

                {# DEFAULT #}
                {% else %}
                  <div class="auth-field">
                    {{ form_label(child, null, { label_attr: { class: 'auth-label' } }) }}
                    <div class="auth-input">
                      {{ form_widget(child) }}
                    </div>
                    {{ form_errors(child) }}
                  </div>
                {% endif %}

              {% endif %}
            {% endfor %}

            {{ form_rest(form) }}

            <div class="partner-actions">
              {% if step > 1 %}
                <button class="btn btn--outline btn--lg" type="submit" name="go_back" value="1">
                  Retour
                </button>
              {% endif %}

              <button class="btn btn--primary btn--lg btn--block" type="submit">
                {{ step < 3 ? 'Continuer' : 'Terminer' }}
              </button>
            </div>

          {{ form_end(form) }}

        </div>
      </div>
    </main>
  </div>

  {# JS minimal pour ajouter des items aux CollectionType #}
  <script>
    function addCollectionItem(containerId) {
      const container = document.getElementById(containerId);
      if (!container) return;

      const prototype = container.dataset.prototype;
      let index = parseInt(container.dataset.index || "0", 10);

      const html = prototype.replace(/__name__/g, index);
      container.dataset.index = (index + 1).toString();

      const wrapper = document.createElement('div');
      wrapper.className = 'auth-input js-item';
      wrapper.innerHTML = html;

      container.appendChild(wrapper);
    }

    document.addEventListener('DOMContentLoaded', () => {
      const addServiceBtn = document.getElementById('add-service');
      if (addServiceBtn) {
        addServiceBtn.addEventListener('click', () => addCollectionItem('services-collection'));
      }

      const addHourBtn = document.getElementById('add-hour');
      if (addHourBtn) {
        addHourBtn.addEventListener('click', () => addCollectionItem('hours-collection'));
      }
    });
  </script>
{% endblock %}
